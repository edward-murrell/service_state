<?php

/**
 * @file
 * Tests for servicestate module
 */

/**
 * 
 */
class ServiceStateTestCase extends DrupalWebTestCase {
  protected $user = null;

  /**
   * Setup our environment for this test.
   */
  public function setUp() {
    parent::setUp(array(
      'servicestate',
      'servicestate_tests'
    ));
    $perms = array_keys(servicestate_permission());
    $this->user = $this->drupalCreateUser($perms);
  }

  /**
   * Provide info to drupal about this test.
   *
   * Displays on the testing page.
   */
  public static function getInfo() {
    // Note: getInfo() string should not be translated.
    return array(
      'name'        => 'Servicestate functional tests',
      'description' => 'Test accessing users search results.',
      'group'       => 'Servicestate',
    );
  }

  /**
   * Test access profiles.
   */
  public function testAccess() {
    $this->drupalGet('servicestate');

    // Should 403 without proper auth here
    $this->assertResponse('403');

    // Login with user account with appropriate role and try again.
    $this->drupalLogin($this->user);
    $this->drupalGet('servicestate');
    $this->assertResponse('200');
  }

  public function testCron() {
    $this->drupalLogin($this->user);

    // Check OK
    $response = $this->drupalGetAJAX('servicestate/json/cron');
    $this->assertEqual(
      $response['status'],
      SERVICESTATE_OK
    );

    // Check never
    variable_del('cron_last');
    $response = $this->drupalGetAJAX('servicestate/json/cron');
    $this->assertEqual(
      $response['status'],
      SERVICESTATE_WARN
    );
    $this->assertEqual(
      $response['error'],
      'Cron has never been run.'
    );

    // Check warning
    variable_set('cron_last',(time() - 1800));
    $response = $this->drupalGetAJAX('servicestate/json/cron');
    $this->assertEqual(
      $response['status'],
      SERVICESTATE_WARN
    );

    // Check critical
    variable_set('cron_last',(time() - 7200));
    $response = $this->drupalGetAJAX('servicestate/json/cron');
    $this->assertEqual(
      $response['status'],
      SERVICESTATE_FAIL
    );
  }
  
}
/*
setup:
disable memcache

tests: 
servicestate_message_variable
servicestate_message_function
ordering
access to json by anonymous
test JSON response in message formats
test html 
create bogus tests?
test memcache built in test is removed
check cron actually returns the results properly
Check SERVICESTATE_NO_SUCH_SERVICE works properly
*/