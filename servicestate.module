<?php
/**
 * @file
 * Module file for servicestate module, which queries and displays the
 * status of upstream services.
 */

define ('SERVICESTATE_ID_PREFIX','servicestate-item');

define ('SERVICESTATE_OK','OK');
define ('SERVICESTATE_WARN','WARNING');
define ('SERVICESTATE_FAIL','FAILURE');
define ('SERVICESTATE_NO_SUCH_SERVICE','nosuchservice');

/**
 * Implements hook_menu().
 */
function servicestate_menu() {
  $items = array();

  $items['servicestate'] = array(
    'title'  => 'Service state',
    'page callback'     => 'servicestate_view_page',
    'access callback'   => TRUE,
    #'access arguments'  => array('view service state page'),
    'type'              => MENU_NORMAL_ITEM,
    'file'              => 'servicestate.page.inc', // temporary
  );
  $items['servicestate/ajax/%'] = array(
    'title'  => 'Service state',
    'page callback'     => 'servicestate_drupal_ajax',
    'page arguments'    => array(2),
    'access callback'   => TRUE,
    #'access arguments'  => array('view service state page'),
    'type'              => MENU_CALLBACK,
    'file'              => 'servicestate.ajax.inc', // temporary
  );

  return $items;
}

/*
 * This is a set of dummy content used to test the display page and
 * callback filters. It will eventually be deleted.
 */
function servicestate_dummy_services() {
  $services = array();

  $services['memcache'] = array(
    'title'         => t('Memcache'),
    'description'   => t('Checks the memcache daemon is up.'),
    'callback'      => 'servicestate_dummy_check',
    'arguments'     => array('error'),
    'group'         => '',
    'weight'        => 0,
    'enabled'       => TRUE,
  );

  $services['smsos'] = array(
    'title'         => t('SMS OS'),
    'description'   => t('Checks the SMSOS service is active..'),
    'callback'      => 'servicestate_dummy_check',
    'arguments'     => array('ok'),
    'group'         => '',
    'weight'        => 0,
    'enabled'       => TRUE,
  );

  return $services;
}

/*
 * This is a set of dummy check used to test the display page and
 * callback filters. It will eventually be deleted.
 */
function servicestate_dummy_check() {
  $args  = func_get_args();
  $nargs = func_num_args();
  if ($nargs > 0) {
    $state = array_pop($args);
  } else {
    $state = 'ok';
  }
  $result = array(
    'status' => strtoupper($state),
  );

  if ($result['status'] == 'OK') {
    $result['message'] = 'Service returns as expected';
  } else {
    $result['error']   = 'Service suffered an unknown error';
  }

  return $result;
}

/*
 * Implementation of hook_theme().
 */
function servicestate_theme($existing, $type, $theme, $path) {
  return array(
    'servicestate_view_table' => array(
      'template' => 'servicestate-view-table',
      'variables' => array(
        'elements' => array(),
      ),
      'file' => 'servicestate.theme.inc',
      #'pattern' =>
    ),
    'servicestate_view_item' => array(
      'template' => 'servicestate-view-item',
      'variables' => array(
        'service' => NULL,
        'data'    => NULL,
        'state'   => NULL,   // Pre rendered state
        'method'  => 'html', // Render on demand, or use ajax?
        'title'  => NULL,
        'state'  => NULL,
      ),
      'file' => 'servicestate.theme.inc',
    )
  );
}

/*
 * @param $id the machine name of the service.
 * Format callback for querying service.
 */
function servicestate_query_callback($id) {
  $services = servicestate_get_services();
  if (!array_key_exists($id,$services)) {
    return array(
      'status' => SERVICESTATE_NO_SUCH_SERVICE,
      'error'  => 'This service does not exist',
    );
  } else {
    $srv  = $services[$id];
  }

  if (array_key_exists('file',$srv) && !empty($srv['file'])) {
    include_once($srv['file']);
  }
  $result = call_user_func_array($srv['callback'],$srv['arguments']);

  // TODO: Some functions may only return a boolean, check for this
  // and format the result accordingly.

  return $result;
}

/*
 * Get a list of all services.
 */
function servicestate_get_services() {
  $services = array();
  // TODO: Add cache here.
  $services = module_invoke_all('servicestate_services');
  return $services;
}

/*
 * Implements hook_servicestate_services
 */
function servicestate_servicestate_services() {
  $services = servicestate_dummy_services();
  $services['cron'] = array(
    'title'         => t('Cron'),
    'description'   => t('Checks the SMSOS service is active..'),
    'callback'      => 'servicestate_cron_check',
    'arguments'     => array(),
    'file'          => 'servicestate.plugins.inc',
    'group'         => '',
    'weight'        => 0,
    'enabled'       => TRUE,
  );
  return $services;
}
